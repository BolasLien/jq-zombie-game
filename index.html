<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
        }

        #game {
            width: 1440px;
            height: 900px;
            background: #000;
            margin: auto;
            position: relative;
            overflow: hidden;
        }

        #panel {
            position: absolute;
            height: 900px;
        }

        .scene {
            width: 1440px;
            height: 900px;
            float: left;
        }

        #scene1 {
            background: url(./scene/00.jpg);
        }

        #scene2 {
            background: url(./scene/01.jpg);
        }

        #scene3 {
            background: url(./scene/02.jpg);
        }

        #scene4 {
            background: url(./scene/03.jpg);
        }

        #scene5 {
            background: url(./scene/04.jpg);
        }

        input[type="button"] {
            width: 120px;
            height: 40px;
        }

        #game img {
            position: absolute;
            height: 150px;

        }

        #controller {
            margin: auto;
            height: 40px;
            width: 1440px;
            background: #fff;
            position: absolute;
            pointer-events: all;
        }

        #ui-panel {
            margin: auto;
            height: 900px;
            width: 1440px;
            position: absolute;
            pointer-events: none;
        }

        #ui-panel #hurt {
            height: 900px;
            width: 1440px;
            background: red;
            opacity: 0;
            position: absolute;
        }

        #ui-panel #dead {
            height: 900px;
            width: 1440px;
            background: url(./ui/you_are_dead.png);
            background-repeat: no-repeat;
            background-position: center center;
            opacity: 0;
            position: absolute;
        }

        #ui-panel #loading {
            height: 900px;
            width: 1440px;
            background: url(./ui/loading.jpg);
            background-repeat: no-repeat;
            background-position: center center;
            opacity: 0;
            position: absolute;
        }
    </style>
</head>

<body>
    <div id="game">

        <div id="panel">
            <div class="scene" id="scene1"></div>
            <div class="scene" id="scene2"></div>
            <div class="scene" id="scene3"></div>
            <div class="scene" id="scene4"></div>
            <div class="scene" id="scene5"></div>
        </div>
        <div id="ui-panel">
            <div id="controller">
                <input type="button" value="遊戲開始" id="start-btn">
                <input type="button" value="結束遊戲" id="over-btn">
                <input type="button" value="回首頁" id="home-btn">
                <input type="button" value="跳下一關" id="next-btn">
                <span>分數：<span id="text-score">0</span></span>
                <span>剩餘時間：<span id="text-time">10</span>秒</span>
                <span>生命值：<span id="text-life">10</span></span>
            </div>
            <div id="game-info">
                <div id="game-time"></div>
                <div id="game-score"></div>
                <div id="game-life"></div>
            </div>
            <div id="hurt"></div>
            <div id="dead"></div>
            <div id="loading"></div>
            <div id="game-result"></div>
        </div>
    </div>


    <script src="jquery-3.5.0.min.js"></script>
    <script>
        $(function () {

            // 是否在遊戲中
            let isPlaying = false;
            // 分數
            let score = 0;
            // 剩餘時間
            let timeleft = 30;
            // 遊戲計時器
            let gametimer = 0;
            // 殭屍流水號
            let itemid = 0;
            //玩家生命
            let life = 10;
            // 現在關卡
            let level = 0;
            // 生東西機率 [boomer, smoke, chager, witch, tank,life]
            let randItem = [0, 30, 20, 40, 0];

            // 畫面大小
            let now = 0;
            const sl = $(".scene").length;
            $("#panel").css("width", sl * 1440);

            // 換頁功能
            const sceneChange = (Num) => {
                now = Num;
                const move = now * 1440;
                $("#panel").stop(true, true)
                $("#panel").animate({ left: `-${move}px` }, 1000)
            }

            // 隨機數字
            const rand = (num) => {
                return Math.round(Math.random() * num);
            }

            //遊戲結束
            const gameOver = () => {
                clearInterval(gametimer);
                // 啟用開始按鈕
                $("#start-btn").attr("disabled", false);

                // 清場
                $("#game img").stop();
                $("#game img").remove();
                itemid = 0;
                sceneChange(4)
                level = 0;
                isPlaying = false;
            }

            //換關卡
            const levelChange = (num) => {
                if (level > 0 && level <= 3) {
                    timeleft = 30;
                    sceneChange(num);

                    $("#loading").fadeTo(100, 1, function () {
                        setTimeout(() => {
                            $(this).fadeTo(1000, 0);

                            // 清場
                            $("#game img").stop();
                            $("#game img").remove();

                            itemid = 0;
                            // [boomer, smoke, chager, witch, tank,life]
                            switch (num) {
                                case 1:
                                    randItem = [0, 100, 100, 100, 0, 20];
                                    break;
                                case 2:
                                    randItem = [100, 0, 100, 0, 0, 20];
                                    break;
                                case 3:
                                    randItem = [0, 0, 0, 0, 100, 20];
                                    break;
                            }
                        }, 1000);
                    })
                }
                else {
                    gameOver();
                }
            }

            //玩家死掉了
            const playerDead = () => {
                $("#dead").fadeTo(10, 1, function () {
                    setTimeout(() => {
                        gameOver();
                        $(this).fadeTo(1000, 0);
                    }, 1000);
                })
            }

            $("#over-btn").click(function () {
                gameOver();
            })
            $("#home-btn").click(function () {
                gameOver();
                sceneChange(0)
            })
            $("#next-btn").click(function () {
                level++;
                timeleft = 30;
                levelChange(level);
            })



            //遊戲開始按鈕
            $("#start-btn").click(function () {
                isPlaying = true;

                level = 1;
                levelChange(level)

                // 停用開始按鈕
                $(this).attr("disabled", true);

                // 重設
                score = 0;
                $("#text-score").text(score);
                timeleft = 30;
                $("#text-time").text(timeleft);
                life = 10;
                $("#text-life").text(life);

                // 遊戲倒數
                gametimer = setInterval(() => {
                    // 倒數
                    timeleft--;
                    $("#text-time").text(timeleft);


                    if (life <= 0) {
                        // 如果玩家死掉了，就結束遊戲
                        playerDead();
                        console.log("你死了");
                    }
                    else if (timeleft == 0) {
                        // // 如果時間到了，判斷還有沒有下一關，否則結束遊戲
                        // if (level > 0 && level < 3) {
                        //     // 如果還有下一關
                        //     level++;
                        //     timeleft = 30;
                        //     levelChange(level);
                        // }
                        // else {
                        //     // 否則結束遊戲
                        //     gameOver();
                        // }
                        level++;
                        levelChange(level);
                        console.log("時間到 現在關卡=" + level);

                    }
                    else {
                        // 10次隨機裡面，如果符合機率就產生東西
                        for (let i = 0; i < 10; i++) {
                            let r = rand(100);
                            let e = rand(5);
                            if (r < (level * 10) && r < randItem[e]) {
                                console.log("e= " + e);
                                createItem(e);

                            }
                        }
                    }
                }, 1000);


            })

            //創建一個東西
            const createItem = (num) => {
                let r = rand(100);
                src = "";
                name = "";

                switch (num) {
                    case 0:
                        src = "./boomer/boomer.gif"
                        name = "boomer";
                        break;
                    case 1:
                        src = "./smoke/smoke.gif"
                        name = "smoke";
                        break;
                    case 2:
                        src = "./chager/chager.gif"
                        name = "chager";
                        break;
                    case 3:
                        // src = "./witch.gif"
                        // name = "witch";
                        src = "./chager/chager.gif"
                        name = "chager";
                        break;
                    case 4:
                        src = (rand(10) > 5) ? "./tank/tank.gif" : "./tank/tank-run.gif";
                        name = "tank";
                        break;
                    case 5:
                        src = "./life.png"
                        name = "life";
                        break;
                }

                // 測試
                // src = "./boomer/boomer.gif"
                // name = "boomer";

                $(`#panel`).append(`<img src=${src} id=item${itemid} class=${name}>`);

                setItemPosition($(`#item${itemid}`));
                moveItem($(`#item${itemid}`))

                itemid++;
            }

            //是不是怪物
            const isEnemy = (item) => {
                return item.hasClass("boomer") || item.hasClass("tank") || item.hasClass("witch") || item.hasClass("chager") || item.hasClass("smoke");
            }

            //取得物品名稱
            const getItemName = (item) => {
                let name = "";

                if (item.hasClass("boomer")) { name = "boomer"; }
                else if (item.hasClass("tank")) { name = "tank"; }
                else if (item.hasClass("witch")) { name = "witch"; }
                else if (item.hasClass("chager")) { name = "chager"; }
                else if (item.hasClass("smoke")) { name = "smoke"; }
                else if (item.hasClass("life")) { name = "life"; }

                return name;
            }

            //設定東西的位置
            const setItemPosition = (item) => {
                item.fadeTo(10, 0, function () {
                    console.log("Set " + getItemName(item) + " Position");
                    switch (getItemName(item)) {
                        case "boomer":
                            item.css({
                                bottom: `${rand(200) + 400}px`,
                                left: `${(1440 * now) + rand(400)}px`
                            })
                            break;
                        case "tank":
                            item.css({
                                height: `+=50px`,
                                bottom: `${250 + rand(100)}px`,
                                left: `${(1440 * now) + 200 + rand(600)}px`
                            })
                            break;
                        case "witch":
                            item.css({
                                bottom: `${rand(200)}px`,
                                left: `${(1440 * now) + rand(1000)}px`
                            })
                            break;
                        case "chager":
                            item.css({
                                height: `+=50px`,
                                bottom: `${100 + rand(100)}px`,
                                left: `${(1440 * now) + 800 + rand(400)}px`
                            })
                            break;
                        case "smoke":
                            item.css({
                                height: `+=150px`,
                                bottom: `${rand(100)}px`,
                                left: `${(1440 * now) + rand(400)}px`
                            })
                            break;
                        case "life":
                            item.css({
                                height: `100px`,
                                bottom: `${rand(200)}px`,
                                left: `${(1440 * now) + rand(1000)}px`
                            })
                            break;
                    }
                })



            }

            // 移動東西
            const moveItem = (item) => {
                item.fadeTo("slow", 1, function () {

                    switch (getItemName(item)) {
                        case "boomer":
                            item.animate({
                                bottom: `-${rand(100)}px`,
                                left: `${(1440 * now) + rand(1000)}px`,
                                height: `+=200px`
                            }, 1500, function () {
                                item.attr("src", "./boomer/boomer-atk.gif")
                                setTimeout(() => { atk(item) }, 500)
                            })
                            break;
                        case "tank":
                            item.animate({
                                height: "+=300px",
                                bottom: `-${rand(100)}px`,
                            }, 1500, function () {
                                let r = rand(10);
                                item.attr("src", (r > 5) ? "./tank/tank-atk.gif" : "./tank/tank-atk2.gif")
                                setTimeout(() => { atk(item) }, (r > 5) ? 1850 : 650)
                            })
                            break;
                        case "witch":
                            console.log("witch no move");
                            break;
                        case "chager":
                            item.animate({
                                height: `+=300px`,
                                bottom: `-${rand(100)}px`,
                                left: `${(1440 * now) + 400 + rand(600)}px`,
                            }, 1500, function () {
                                item.attr("src", "./chager/chager-atk.gif")
                                setTimeout(() => { atk(item) }, 550)
                            })
                            break;
                        case "smoke":
                            item.animate({
                                height: `+=50px`
                            }, 1000, function () {
                                item.attr("src", "./smoke/smoke-atk.gif")
                                setTimeout(() => { atk(item) }, 600)
                            })
                            break;
                        case "life":
                            item.animate({
                                bottom: `+=50px`,
                            }, 500).animate({
                                bottom: `-=50px`,
                            }, 500, function () {
                                moveItem(item);
                            })
                            break;
                    }

                })

            }

            //怪物攻擊
            const atk = (enemy) => {

                if (isPlaying && !enemy.hasClass("dead")) {
                    console.log("atk");
                    $("#hurt").fadeTo(150, 0.3).fadeTo(200, 0, function () {
                        console.log(getItemName(enemy) + " atk you");
                        switch (getItemName(enemy)) {
                            case "boomer":
                                life--;
                                break;
                            case "tank":
                                life -= 3;
                                break;
                            case "witch":

                                break;
                            case "chager":
                                life -= 2;
                                break;
                            case "smoke":
                                life--;
                                break;
                        }
                        $("#text-life").text(life);

                        // atk(enemy);
                    })

                }


            }

            //點擊item事件
            $("#game").on("mousedown", "img", function () {
                if (!isPlaying) {
                    return;
                }

                if (isEnemy($(this))) {
                    $(this).addClass("dead")
                    $(this).attr("src", "./blood.png")
                    $(this).stop();
                    $(this).css({
                        height: `100px`,
                        width: `200px`
                    })
                    $(this).fadeOut("slow");
                    // score++;

                    // 點到的怪物計分
                    switch (getItemName($(this))) {
                        case "boomer":
                            score += 2;
                            break;
                        case "tank":
                            score += 10;
                            break;
                        case "witch":

                            break;
                        case "chager":
                            score += 5;
                            break;
                        case "smoke":
                            score += 3;
                            break;
                    }
                    $("#text-score").text(score);
                }
                else {
                    $(this).remove();
                    $(this).stop();
                    life++;
                    $("#text-life").text(life);

                }

                console.log("click " + getItemName($(this)));



                $(this).css("pointer-events", "none");

            })


        })


    </script>
</body>

</html>