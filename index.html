<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            background-color: #000;
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
            font-family: 'Microsoft JhengHei';
        }

        #game {
            width: 1440px;
            height: 900px;
            background: #000;
            margin: auto;
            position: relative;
            overflow: hidden;
        }

        #panel {
            position: absolute;
            height: 900px;
        }

        .scene {
            width: 1440px;
            height: 900px;
            float: left;
        }

        .blur {
            filter: blur(4px);
            -o-filter: blur(4px);
            -ms-filter: blur(4px);
            -moz-filter: blur(4px);
            -webkit-filter: blur(4px);
        }

        #scene1 {
            background: url(./scene/00.jpg);
        }

        #scene2 {
            background: url(./scene/01.jpg);
        }

        #scene3 {
            background: url(./scene/02.jpg);
        }

        #scene4 {
            background: url(./scene/03.jpg);
        }

        #scene5 {
            background: url(./scene/04.jpg);
        }

        input[type="button"] {
            width: 120px;
            height: 40px;
        }

        #game img {
            position: absolute;
            height: 150px;
        }

        #controller {
            margin: auto;
            height: 40px;
            width: 1440px;
            background: #fff;
            position: absolute;
            pointer-events: all;
        }

        #ui-panel {
            margin: auto;
            height: 900px;
            width: 1440px;
            position: absolute;
            pointer-events: none;
        }

        #HUD,
        #hurt,
        #dead,
        #loading,
        #time-out,
        #game-result {
            height: 900px;
            width: 1440px;
            opacity: 0;
            position: absolute;
            background-repeat: no-repeat;
            background-position: center center;
        }

        #ui-panel #HUD #game-time {
            background-image: url(./ui/game-time.png);
            width: 301px;
            height: 64px;
            position: absolute;
            left: 780px;
            top: 50px;
            font-size: 50px;
            color: #fff;
            text-align: center;
            line-height: 64px;
        }

        #ui-panel #HUD #game-score {
            background-image: url(./ui/game-score.png);
            width: 301px;
            height: 66px;
            position: absolute;
            left: 400px;
            top: 50px;
            font-size: 50px;
            color: #f00;
            text-align: center;
            line-height: 66px;

        }

        #ui-panel #HUD #game-life {
            background-image: url(./ui/game-life.png);
            width: 303px;
            height: 75px;
            position: absolute;
            right: 50px;
            bottom: 50px;
        }

        #ui-panel #HUD #game-life #game-life-bar {
            width: 223px;
            height: 30px;
            position: absolute;
            right: 4px;
            bottom: 2px;
        }

        #ui-panel #HUD #game-life #game-life-bg {
            background-image: url(./ui/game-life-bg.png);
            width: 30px;
            height: 30px;
            position: absolute;
            left: 80px;
            bottom: 40px;
        }

        #ui-panel #HUD #game-life #game-life-text {
            font-size: 30px;
            color: #00ff22;
            height: 30px;
            position: absolute;
            left: 120px;
            bottom: 40px;
            line-height: 30px;
        }

        #ui-panel #hurt {
            background-color: red;
        }

        #ui-panel #dead {
            background-color: rgba(255, 0, 0, 0.3);
            background-image: url(./ui/you_are_dead.png);
        }

        #ui-panel #loading {
            background-image: url(./ui/loading.jpg);
        }

        #ui-panel #loading #loading-bar {
            position: absolute;
            width: 220px;
            height: 20px;
            transform: translate(890px, 640px);
        }

        #ui-panel #time-out {
            background-image: url(./ui/time-out.png);
        }

        #ui-panel #time-out #next-level-btn {
            position: absolute;
            width: 164px;
            height: 53px;
            left: 640px;
            top: 470px;
            pointer-events: all;
            background-image: url(./ui/next-level-btn.png);
        }

        #ui-panel #time-out #next-level-btn:hover {
            filter: hue-rotate(240deg);
            cursor: pointer;
        }

        #ui-panel #game-result #title {
            position: absolute;
            width: 373px;
            height: 53px;
            left: 520px;
            top: 50px;
            background-image: url(./ui/Game-Result.png);
        }

        #ui-panel #game-result #home {
            position: absolute;
            width: 164px;
            height: 53px;
            left: 640px;
            top: 800px;
            pointer-events: all;
            background-image: url(./ui/home-btn.png);
        }

        #ui-panel #game-result #home:hover {
            filter: hue-rotate(240deg);
            cursor: pointer;
        }

        #ui-panel #game-result {

            background-image: url(./ui/result-frame.png);
        }

        #ui-panel #game-result #board {
            width: 1046px;
            height: 574px;
            position: absolute;
            left: 197px;
            top: 163px;
        }

        #ui-panel #game-result #board #record {
            top: 37px;
            width: 480px;
            height: 500px;
            position: relative;
            float: left;
            left: 50px;
            font-size: 50px;
            color: #999;
            text-shadow: 2px 2px 5px #000000;
            line-height: 2;
        }

        #ui-panel #game-result #board #record #record-life {
            color: #00ff22;
        }

        #ui-panel #game-result #board #record-score {
            color: #f00;
        }

        #ui-panel #game-result #board #record-total-score {
            color: #ffffcc;
        }

        #ui-panel #game-result #board #record-text {
            font-size: 20px;
            line-height: 10px;
        }

        #ui-panel #game-result #board #record-board {
            top: 37px;
            width: 480px;
            height: 500px;
            position: relative;
            float: left;
            left: 40px;
            color: #ffffcc;
            font-size: 40px;
            line-height: 50px;

        }

        #record-board-table tr td {
            width: 200px;
            text-align: center;
        }

        .rank {
            font-size: 30px;
            line-height: 40px;
        }

        .popText {
            position: absolute;
            font-size: 20px;
            text-align: center;
            height: 20px;
        }
    </style>
</head>

<body>
    <div id="game">

        <div id="panel">
            <div class="scene" id="scene1"></div>
            <div class="scene" id="scene2"></div>
            <div class="scene" id="scene3"></div>
            <div class="scene" id="scene4"></div>
            <div class="scene" id="scene5"></div>
        </div>
        <div id="ui-panel">
            <div id="controller">
                <input type="button" value="遊戲開始" id="start-btn">
                <input type="button" value="結束遊戲" id="over-btn">
                <input type="button" value="回首頁" id="home-btn">
                <input type="button" value="跳下一關" id="next-btn">
                <span>殺敵得分：<span id="text-score">0</span></span>
                <span>剩餘時間：<span id="text-time">10</span>秒</span>
                <span>生命值：<span id="text-life">10</span></span>
            </div>
            <div id="HUD">
                <div id="game-time"></div>
                <div id="game-score"></div>
                <div id="game-life">
                    <progress id="game-life-bar" value="10" max="100"></progress>
                    <div id="game-life-bg"></div>
                    <div id="game-life-text">10</div>
                </div>
            </div>
            <div id="hurt"></div>
            <div id="dead"></div>
            <div id="time-out">
                <div id="next-level-btn"></div>
            </div>
            <div id="loading">
                <progress id="loading-bar" value="0" max="100"></progress>
            </div>
            <div id="game-result">
                <div id="title"></div>
                <div id="board">
                    <div id="record-board">
                        <table id="record-board-table">
                            <tr>
                                <td>名次</td>
                                <td>玩家</td>
                                <td>總成績</td>
                            </tr>
                        </table>
                    </div>
                    <div id="record">
                        <div id="name">玩家：<span id="record-name"></span></div>
                        <div id="score">殺敵得分：<span id="record-score">0</span></div>
                        <div id="life">生命值：<span id="record-life">10</span></div>
                        <div id="total-score">總成績：<span id="record-total-score">0</span></div>
                        <div id="record-text">*總成績 = 殺敵得分 + (生命值 x 10)</div>
                    </div>
                </div>
                <div id="home"></div>
            </div>
        </div>
    </div>


    <script src="./scripts/jquery-3.5.0.min.js"></script>
    <script src="./scripts/gameData.js"></script>
    <script src="./scripts/recordBoard.js"></script>
    <script>
        $(function () {

            // 是否在遊戲中
            let isPlaying = false;
            // 遊戲讀取中
            let isLoading = false;
            // 分數
            let score = 0;
            // 剩餘時間
            let timeleft = 30;
            // 遊戲計時器
            let gametimer = 0;
            // 殭屍流水號
            let itemid = 0;
            //玩家生命
            let life = 10;
            // 現在關卡
            let level = 0;
            // 生東西機率 [boomer, smoke, chager, witch, tank, tank-run, life]
            let randItem = [];
            // 背景音樂
            let audio = new Audio();


            const audioPlay = (src) => {
                audio.src = src;
                audio.play();
            }

            audioPlay(soundData.home);
            $("#home").css("pointer-events", "none")
            $("#next-level-btn").css("pointer-events", "none")


            // 畫面大小
            let now = 0;
            const sl = $(".scene").length;
            $("#panel").css("width", sl * 1440);

            // 換頁功能
            const sceneChange = (Num) => {
                now = Num;
                const move = now * 1440;
                $("#panel").stop(true, true)
                $("#panel").animate({ left: `-${move}px` }, 1000)
            }

            // pop text
            const popText = (text, color, left, top, width) => {
                console.log(`left=${left} top=${top} width=${width}`);
                $("#panel").append(`<div class="popText" style="color:${color}; left:${left}; top:${top}; width:${width}">${text}</div>`);
                $(`.popText`).animate({ top: "-=50px" }, 500).fadeTo(500, 0, function () {
                    $(this).remove();
                })
            }

            // 隨機數字
            const rand = (num) => {
                return Math.round(Math.random() * num);
            }

            // 分數改變
            const changeScore = (num) => {
                $("#text-score").text(num);
                $("#game-score").text(num);
                $("#record-score").text(num)
            }

            // 生命值改變
            const changeLife = (num) => {
                $("#text-life").text(num)
                $("#record-life").text(num);
                $("#game-life-text").text(num);
                $("#game-life-bar").val(num);
            }

            //遊戲結束
            const gameOver = () => {
                // 關閉HUD
                $("#HUD").fadeTo(100, 0)

                // 更新分數及生命值
                changeScore(score);
                changeLife(life);
                $("#record-total-score").text(0)

                // 上傳成績
                $("#record-name").text("訪客" + rand(200));
                let r = createRecord($("#record-name").text(), score + (life * 10));
                setRecords(r);

                // 列出排行榜名單
                $(".rank").remove();
                if (records.length > 0) {
                    rank = 1;
                    for (let record of records) {
                        $("#record-board-table").append(`<tr class="rank">
                            <td>${rank}</td>
                            <td>${record.name}</td>
                                <td>${record.totalScore}</td></tr>`)
                        rank++;
                    }
                }

                // 遊戲結算畫面開啟
                setTimeout(() => {
                    $("#game-result").fadeTo(500, 1);
                    $("#home").css("pointer-events", "all")
                    audioPlay(soundData.end);

                }, 1000);

                // 總成績計算演出
                let timer = setInterval(() => {
                    $("#record-total-score").text(rand(score + life * 10))
                }, 50);
                setTimeout(() => {
                    clearInterval(timer);
                    $("#record-total-score").text(score + life * 10)
                }, 3000);

                clearInterval(gametimer);

                // 啟用開始按鈕
                $("#start-btn").attr("disabled", false);

                // 清場
                $("#game img").stop();
                $("#game img").remove();

                itemid = 0;
                level = 0;
                isPlaying = false;
                sceneChange(4)

            }

            //換關卡
            const levelChange = (num) => {
                if (level > 0 && level <= 3) {
                    // 如果還有下一關

                    console.log("換關卡中");
                    isLoading = true;

                    //讀取條歸零
                    $("#loading-bar").val(0)
                    //背景模糊
                    $("#panel").addClass("blur");
                    // 打開HUD
                    $("#HUD").fadeTo(500, 0);

                    // 清場
                    $("#game img").stop();
                    $("#game img").remove();

                    // loading畫面
                    $("#loading").fadeTo(100, 1, function () {
                        // loading秒數
                        let tl = 2000;

                        // 讀取條
                        let i = 0;
                        let timer = setInterval(() => {
                            $("#loading-bar").val(i * tl / 160)
                            i++;
                        }, tl / 10);

                        setTimeout(() => {
                            audioPlay(soundData.level[level - 1]);


                            $("#panel").removeClass("blur");
                            // 打開HUD
                            $("#HUD").fadeTo(1000, 1);

                            clearInterval(timer);
                            timeleft = 30;
                            sceneChange(num);
                            $(this).fadeTo(300, 0);
                            itemid = 0;

                            // 關卡的隨機資料
                            randItem = levelData[num - 1];

                            isLoading = false;

                        }, tl);
                    })
                }
                else {
                    // 遊戲結束
                    gameOver();
                }
            }

            $("#home").click(function () {
                $("#game-result").fadeTo(200, 0);
                sceneChange(0)
                $("#home").css("pointer-events", "none")
            })

            $("#over-btn").click(function () {
                gameOver();
            })
            $("#home-btn").click(function () {
                $("#game-result").fadeTo(200, 0);
                $("#HUD").fadeTo(200, 0);
                level = 0;
                sceneChange(0)
                $("#home").css("pointer-events", "none")
            })
            $("#next-btn").click(function () {
                level++;
                levelChange(level);
            })

            $("#next-level-btn").click(function () {
                $("#time-out").fadeTo(300, 0, function () {
                    $("#panel").removeClass("blur")
                    level++;
                    levelChange(level);
                })
                $("#next-level-btn").css("pointer-events", "none")
                $("#panel").css("pointer-events", "all")
                isPlaying = true;
            })

            //遊戲開始按鈕
            $("#start-btn").click(function () {
                isPlaying = true;

                level = 1;
                levelChange(level)

                // 停用開始按鈕
                $(this).attr("disabled", true);

                // 重設
                score = 0;
                changeScore(score);

                timeleft = 30;
                $("#text-time").text(timeleft);
                $("#game-time").text(timeleft);

                life = 10;
                changeLife(life);


                // 遊戲倒數
                gametimer = setInterval(() => {

                    // 如果現在正在loading就跳出
                    if (isLoading) {
                        return;
                    }

                    // 倒數
                    timeleft--;
                    $("#text-time").text(timeleft);
                    $("#game-time").text(timeleft);


                    if (life <= 0) {
                        life = 0;
                        // 如果玩家死掉了，就結束遊戲
                        $("#dead").fadeTo(100, 1, function () {
                            $("#panel").addClass("blur")
                            setTimeout(() => {
                                gameOver();

                                $("#panel").removeClass("blur")
                                $(this).fadeTo(300, 0);
                            }, 1500);
                        })

                        console.log("你死了");
                    }
                    else if (timeleft == 0) {
                        isLoading = true;
                        isPlaying = false;
                        // 時間到換關卡
                        $("#panel").addClass("blur")
                        $("#time-out").fadeTo(100, 1)
                        $("#next-level-btn").css("pointer-events", "all")
                        $("#panel").css("pointer-events", "none")

                        console.log("時間到");
                    }
                    else {
                        // 10次隨機裡面，如果符合機率就產生東西
                        for (let i = 0; i < 10; i++) {
                            let r = rand(100);
                            let e = rand(6);
                            if (r < (level * 10) && r < randItem[e]) {
                                createItem(e);
                            }
                        }
                    }
                }, 1000);


            })

            //創建一個東西
            const createItem = (num) => {
                let r = rand(100);
                src = itemData[num].srcNormal;
                name = itemData[num].name;

                // 測試
                // src = "./boomer/boomer.gif"
                // name = "boomer";

                $(`#panel`).append(`<img src=${src} id=item${itemid} class=${name}>`);

                setItemPosition($(`#item${itemid}`));
                moveItem($(`#item${itemid}`))

                itemid++;
            }

            //是不是怪物
            const isEnemy = (item) => {
                return item.hasClass("boomer") || item.hasClass("tank") || item.hasClass("witch") || item.hasClass("chager") || item.hasClass("smoke") || item.hasClass("tank-run");
            }

            //取得物品名稱
            const getItemName = (item) => {
                let name = "";

                if (item.hasClass("boomer")) { name = "boomer"; }
                else if (item.hasClass("tank")) { name = "tank"; }
                else if (item.hasClass("tank-run")) { name = "tank-run"; }
                else if (item.hasClass("witch")) { name = "witch"; }
                else if (item.hasClass("chager")) { name = "chager"; }
                else if (item.hasClass("smoke")) { name = "smoke"; }
                else if (item.hasClass("life")) { name = "life"; }

                return name;
            }

            //設定東西的位置
            const setItemPosition = (item) => {
                item.fadeTo(10, 0, function () {
                    console.log("Set " + getItemName(item) + " Position");
                    for (let obj of itemData) {
                        if (getItemName(item) == obj.name) {
                            item.css(obj.setPosition[level - 1][0])
                        }
                    }
                })
            }

            // 移動東西
            const moveItem = (item) => {
                item.fadeTo("slow", 1, function () {
                    for (let obj of itemData) {
                        if (getItemName(item) == obj.name) {
                            if (isEnemy(item)) {
                                item.animate(obj.moveTo[level - 1][0], 1500, function () {
                                    item.attr("src", obj.srcAtk)
                                    setTimeout(() => { atk(item) }, obj.atkWait);
                                })
                            }
                            else {
                                item.animate(obj.moveTo[level - 1][0], 500).animate(obj.moveTo[level - 1][1], 500, function () {
                                    moveItem(item)
                                })
                            }
                        }
                    }
                })

            }

            //怪物攻擊
            const atk = (enemy) => {
                if (isPlaying && !enemy.hasClass("dead")) {
                    $("#hurt").fadeTo(150, 0.3).fadeTo(200, 0, function () {
                        console.log(getItemName(enemy) + " atk you");
                        for (let obj of itemData) {
                            if (getItemName(enemy) == obj.name) {
                                life -= obj.atk;
                            }
                        }
                        changeLife(life);

                    })
                }
            }

            //點擊item事件
            $("#game").on("mousedown", "img", function () {
                if (!isPlaying) {
                    return;
                }

                if (isEnemy($(this))) {
                    // 點到的怪物計分
                    for (let obj of itemData) {
                        if (getItemName($(this)) == obj.name) {
                            score += obj.score;
                            popText(obj.score, "#f00", $(this).css("left"), $(this).css("top"), $(this).css("width"));
                        }
                    }

                    $(this).addClass("dead")
                    $(this).attr("src", "./UI/blood.png")
                    $(this).stop();
                    $(this).css({
                        height: `100px`,
                        width: `200px`
                    })
                    $(this).fadeOut("slow");




                    changeScore(score);
                }
                else {
                    life++;
                    changeLife(life);
                    popText(1, "#0f0", $(this).css("left"), $(this).css("top"), $(this).css("width"));

                    $(this).remove();
                    $(this).stop();

                }

                $(this).css("pointer-events", "none");

                console.log("click " + getItemName($(this)));
            })




        })


    </script>
</body>

</html>